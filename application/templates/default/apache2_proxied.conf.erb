# Apache proxied app vhost
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#

<VirtualHost *:80>
  ServerName <%= @app[:domain_name] %>
  <% (@app[:domain_aliases] || []).each do |a| %>
  ServerAlias <%= a %>
  <% end %>
  ServerAdmin <%= node[:apache][:contact] %>

  <% if (@app[:ssl] || {})[:required] %>
  <IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://<%= @app[:domain_name] %>$1 [R=301,L]
  </IfModule>
  <% else %>
  ProxyPreserveHost on
  <Proxy *>
    Order deny,allow
    Allow from all
    <% if (@app[:auth] || {})['type'] == 'basic' && !(@app['ssl'] || {})['required'] %>
    AuthType Basic
    AuthName <%= @app['id'] %>
    AuthUserFile <%= node['apache']['dir'] %>/passwd/<%= @app['id'] %>.htpasswd
    Require valid-user
    <% end %>
  </Proxy>
  ProxyPass / http://localhost:<%= @app[:port] %>/
  ProxyPassReverse / http://localhost:<%= @app[:port] %>
  <% end %>
</VirtualHost>

<% if (@app[:ssl] || {})[:on] %>
<VirtualHost <%= @app[:ssl][:ip] || node[:ipaddress] %>:443>
  ServerName <%= @app[:domain_name] %>
  ServerAdmin <%= node[:apache][:contact] %>

  ProxyRequests off
  ProxyPreserveHost on
  <Proxy *>
    Order deny,allow
    Allow from all
    <% if (@app[:auth] || {})['type'] == 'basic' %>
    AuthType Basic
    AuthName <%= @app['id'] %>
    AuthUserFile <%= node['apache']['dir'] %>/passwd/<%= @app['id'] %>.htpasswd
    Require valid-user
    <% end %>
  </Proxy>
  ProxyPass / http://localhost:<%= @app[:port] %>/
  ProxyPassReverse / http://localhost:<%= @app[:port] %>
  ProxyPassReverse / http://<%= @app[:domain_name] %>

  SSLEngine on
  SSLCertificateFile <%= "#{node[:apache][:dir]}/ssl/#{@app[:domain_name]}.pem" %>
  SSLCertificateKeyFile <%= "#{node[:apache][:dir]}/ssl/#{@app[:domain_name]}.key" %>
</VirtualHost>
<% end %>
