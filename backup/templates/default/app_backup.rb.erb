##
# Backup
# Chef Generated Template
#

<% @models.each do |model| %>
Backup::Model.new(:<%= model[:id] %>, '<%= model[:title] || model[:id] %>') do
  <% (model[:databases] || {}).each_pair do |db, config| %>
  database <%= db %> do |db|
    db.name = '<%= config[:name] || model[:app_db][:database] %>'
    db.username = '<%= config[:username] || model[:app_db][:username] %>'
    db.password = '<%= config[:password] || model[:app_db][:password] %>'
    db.host = '<%= config[:host] || model[:app_db][:host] || 'localhost' %>'
    db.port = <%= config[:port] || model[:app_db][:port] || '3306' %>
    db.additional_options = <%= (config[:additional_options] || ['--quick', '--single-transaction']).to_json %>
  end
  <% end %>

  <% (model[:store_with] || {}).each_pair do |storage, config| %>
  store_with <%= storage %> do |s|
    <% if storage == 'CloudFiles' && node[:backup][:rackspace_api_username] && node[:backup][:rackspace_api_key] %>
    s.api_key = '<%= node[:backup][:rackspace_api_key] %>'
    s.username = '<%= node[:backup][:rackspace_api_username] %>'
    s.container = '<%= config[:container] || 'backup' %>'
    <% if config[:keep] %>
    s.keep = <%= config[:keep] %>
    <% end %>
    <% end %>
  end
  <% end %>

  <% (model[:sync_with] || {}).each_pair do |syncer, config| %>
  sync_with <%= syncer %> do |s|
    <% if syncer == 'S3' && node['backup']['aws_access_key_id'] && node['backup']['aws_secret_access_key'] %>
    s.access_key_id = '<%= node['backup']['aws_access_key_id'] %>'
    s.secret_access_key = '<%= node['backup']['aws_secret_access_key'] %>'
    s.bucket = '<%= config['bucket'] || 'backup' %>'
    s.mirror = <%= !!config['mirror'] %>
    <% end %>
    s.directories do |directory|
    <% (config['directories'] || []).each do |dir| %>
      directory.add '<%= dir %>'
    <% end %>
    end
  end
  <% end %>

  <% if model[:archive] %>
  archive :<%= model[:archive][:id] || model[:id] %> do |archive|
  <% (model[:archive][:add] || []).each do |path| %>
    archive.add '<%= path %>'
  <% end %>
  <% (model[:archive][:exclude] || []).each do |path| %>
    archive.exclude '<%= path %>'
  <% end %>
  end
  <% end %>

  <% unless model[:compress] == false %>
  compress_with Gzip do |compression|
    compression.best = true
    compression.fast = false
  end
  <% end %>

end

<% end %>

